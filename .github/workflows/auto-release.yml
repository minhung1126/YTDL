name: "Auto Release"

on:
  # Only trigger on push to the main branch
  push:
    branches:
      - "main"
  # Allow manual trigger
  workflow_dispatch:

jobs:
  auto-release:
    name: "Auto Release"
    runs-on: "ubuntu-latest"

    # Grant the GITHUB_TOKEN write permission to create a release
    permissions:
      contents: write

    steps:
      # Step 1: Checkout the repository code
      - name: "Checkout code"
        uses: actions/checkout@v4

      # Step 2: Extract the __version__ from YTDL.py
      - name: "Extract version from YTDL.py"
        id: version_extractor
        run: |
          # Find the line starting with __version__ to ignore commented lines
          VERSION=$(grep '^__version__' YTDL.py | cut -d '"' -f 2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        
      # Step 3: Package YTDL.py, YTDL_mul.py, and self_update.py into a zip file
      - name: "Package files into a zip"
        if: steps.version_extractor.outputs.version != 'dev'
        run: zip "YTDL.${{ steps.version_extractor.outputs.version }}.zip" YTDL.py YTDL_mul.py self_update.py

      # Step 4: Create the new release using the extracted version
      - name: "Create Release"
        if: steps.version_extractor.outputs.version != 'dev'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ steps.version_extractor.outputs.version }} \
            "YTDL.${{ steps.version_extractor.outputs.version }}.zip" \
            --title "Release ${{ steps.version_extractor.outputs.version }}" \
            --notes "下載YTDL.${{ steps.version_extractor.outputs.version }}.zip，之後解壓縮即可使用。"